//
// Generated By: dol2asm
// Translation Unit: J3DModel
//

#include "JSystem/J3DGraphAnimator/J3DModel.h"
#include "JSystem/J3DGraphAnimator/J3DMaterialAnm.h"
#include "JSystem/J3DGraphBase/J3DMaterial.h"
#include "dolphin/os.h"

/* 80327100-80327184 321A40 0084+00 0/0 3/3 0/0 .text            initialize__8J3DModelFv */
void J3DModel::initialize() {
    mModelData = NULL;
    mFlags = 0;
    mDiffFlag = 0;
    mCalcCallBack = NULL;
    mUserArea = 0;

    mBaseScale.x = 1.0f;
    mBaseScale.y = 1.0f;
    mBaseScale.z = 1.0f;

    MTXIdentity(mBaseTransformMtx);
    MTXIdentity(mInternalView);

    mMtxBuffer = NULL;
    mMatPacket = NULL;
    mShapePacket = NULL;
    mDeformData = NULL;
    mSkinDeform = NULL;
    mVtxColorCalc = NULL;
    mUnkCalc1 = NULL;
    mUnkCalc2 = NULL;
}

/* 80327184-80327300 321AC4 017C+00 0/0 3/3 0/0 .text
 * entryModelData__8J3DModelFP12J3DModelDataUlUl                */
s32 J3DModel::entryModelData(J3DModelData* p_modelData, u32 modelFlag, u32 mtxBufferFlag) {
    mModelData = p_modelData;
    mMtxBuffer = new J3DMtxBuffer();

    if (mMtxBuffer == NULL) {
        return 4;
    }

    s32 ret = mMtxBuffer->create(p_modelData, mtxBufferFlag);
    if (ret) {
        return ret;
    }
    ret = createShapePacket(p_modelData);
    if (ret) {
        return ret;
    }
    ret = createMatPacket(p_modelData, modelFlag);
    if (ret) {
        return ret;
    }

    mVertexBuffer.setVertexData(&p_modelData->getVertexData());
    prepareShapePackets();

    if (modelFlag & J3DMdlFlag_Unk00001) {
        onFlag(J3DMdlFlag_Unk00001);
    }
    if (modelFlag & J3DMdlFlag_Unk00002) {
        onFlag(J3DMdlFlag_Unk00002);
    }
    if (modelFlag & J3DMdlFlag_Unk00010) {
        onFlag(J3DMdlFlag_Unk00010);
    }
    if (modelFlag & J3DMdlFlag_Unk20000) {
        onFlag(J3DMdlFlag_Unk20000);
    }
    if (modelFlag & J3DMdlFlag_Unk40000) {
        onFlag(J3DMdlFlag_Unk40000);
    }
    if (modelFlag & J3DMdlFlag_Unk80000) {
        onFlag(J3DMdlFlag_Unk80000);
    }
    if (modelFlag & J3DMdlFlag_SkinPosCpu) {
        onFlag(J3DMdlFlag_SkinPosCpu);
    }
    if (modelFlag & J3DMdlFlag_SkinNrmCpu) {
        onFlag(J3DMdlFlag_SkinNrmCpu);
    }
    return 0;
}

/* 80327300-803273CC 321C40 00CC+00 1/1 0/0 0/0 .text createShapePacket__8J3DModelFP12J3DModelData
 */
s32 J3DModel::createShapePacket(J3DModelData* p_modelData) {
    if (p_modelData->getShapeNum() != 0) {
        u16 shapeNum = p_modelData->getShapeNum();

        mShapePacket = new J3DShapePacket[shapeNum];

        if (mShapePacket == NULL) {
            return kJ3DError_Alloc;
        }

        for (int i = 0; i < p_modelData->getShapeNum(); i++) {
            J3DShape* shapeNode = p_modelData->getShapeNodePointer(i);
            mShapePacket[i].setShape(shapeNode);
            mShapePacket[i].setModel(this);
        }
    }

    return kJ3DError_Success;
}

/* 803273CC-803275FC 321D0C 0230+00 1/1 0/0 0/0 .text createMatPacket__8J3DModelFP12J3DModelDataUl
 */
s32 J3DModel::createMatPacket(J3DModelData* p_modelData, u32 flag) {
    if (p_modelData->getMaterialNum() != 0) {
        mMatPacket = new J3DMatPacket[p_modelData->getMaterialNum()];

        if (mMatPacket == NULL) {
            return kJ3DError_Alloc;
        }
    }

    s32 ret;
    u16 matNum = p_modelData->getMaterialNum();

    u32 singleDLFlag = flag & 0x40000;
    for (u16 i = 0; i < matNum; i++) {
        J3DMaterial* materialNode = p_modelData->getMaterialNodePointer(i);
        J3DMatPacket* pkt = mMatPacket + i;

        u16 shapeIndex = materialNode->getShape()->getIndex();
        J3DShapePacket* shapePacket = mShapePacket + shapeIndex;

        pkt->setMaterial(materialNode);
        pkt->setInitShapePacket(shapePacket);
        pkt->addShapePacket(shapePacket);
        pkt->setTexture(p_modelData->getTexture());
        pkt->setMaterialID(materialNode->mDiffFlag);

        if (p_modelData->getModelDataType() == 1) {
            pkt->mFlags |= 0x01;
        }

        if (!!(flag & 0x80000)) {
            pkt->mpDisplayListObj = materialNode->getSharedDisplayListObj();
        } else {
            if (p_modelData->getModelDataType() == 1) {
                if (!!(flag & 0x40000)) {
                    pkt->mpDisplayListObj = materialNode->getSharedDisplayListObj();
                } else {
                    J3DDisplayListObj* sharedDL = materialNode->getSharedDisplayListObj();
                    ret = sharedDL->single_To_Double();
                    if (ret != kJ3DError_Success)
                        return ret;

                    pkt->mpDisplayListObj = sharedDL;
                }
            } else if (!!(flag & 0x20000)) {
                if (!!(flag & 0x40000)) {
                    ret = materialNode->newSingleSharedDisplayList(materialNode->countDLSize());
                    if (ret != kJ3DError_Success)
                        return ret;

                    pkt->mpDisplayListObj = materialNode->getSharedDisplayListObj();
                } else {
                    ret = materialNode->newSharedDisplayList(materialNode->countDLSize());
                    if (ret != kJ3DError_Success)
                        return ret;

                    J3DDisplayListObj* sharedDL = materialNode->getSharedDisplayListObj();
                    ret = sharedDL->single_To_Double();
                    if (ret != kJ3DError_Success)
                        return ret;

                    pkt->mpDisplayListObj = sharedDL;
                }
            } else {
                if (!!(flag & 0x40000)) {
                    ret = pkt->newSingleDisplayList(materialNode->countDLSize());
                    if (ret != kJ3DError_Success)
                        return ret;
                } else {
                    ret = pkt->newDisplayList(materialNode->countDLSize());
                    if (ret != kJ3DError_Success)
                        return ret;
                }
            }
        }
    }

    return kJ3DError_Success;
}

/* 803275FC-8032767C 321F3C 0080+00 0/0 1/1 0/0 .text newDifferedDisplayList__8J3DModelFUl */
s32 J3DModel::newDifferedDisplayList(u32 flag) {
    mDiffFlag = flag;
    u16 shapeNum = getModelData()->getShapeNum();
    for (u16 i = 0; i < shapeNum; i++) {
        s32 ret = mShapePacket[i].newDifferedDisplayList(flag);
        if (ret != kJ3DError_Success)
            return ret;
    }
    return kJ3DError_Success;
}

/* 8032767C-803276B4 321FBC 0038+00 0/0 4/4 0/0 .text            lock__8J3DModelFv */
void J3DModel::lock() {
    u16 matNum = mModelData->getMaterialNum();

    for (int i = 0; i < matNum; i++) {
        mMatPacket[i].lock();
    }
}

/* 803276B4-803276EC 321FF4 0038+00 0/0 2/2 0/0 .text            unlock__8J3DModelFv */
void J3DModel::unlock() {
    u16 matNum = mModelData->getMaterialNum();

    for (int i = 0; i < matNum; i++) {
        mMatPacket[i].unlock();
    }
}

/* 803276EC-80327858 32202C 016C+00 1/0 0/0 0/0 .text            calcMaterial__8J3DModelFv */
void J3DModel::calcMaterial() {
    j3dSys.setModel(this);

    if (checkFlag(4)) {
        j3dSys.onFlag(4);
    } else {
        j3dSys.offFlag(4);
    }

    if (checkFlag(8)) {
        j3dSys.onFlag(8);
    } else {
        j3dSys.offFlag(8);
    }

    mModelData->syncJ3DSysFlags();
    j3dSys.setTexture(mModelData->getTexture());

    u16 matNum = mModelData->getMaterialNum();
    for (u16 i = 0; i < matNum; i++) {
        j3dSys.setMatPacket(&mMatPacket[i]);

        J3DMaterial* material = mModelData->getMaterialNodePointer(i);
        if (material->getMaterialAnm() != NULL) {
            material->getMaterialAnm()->calc(material);
        }

        int jntNo = material->getJoint()->getJntNo();
        material->calc(getAnmMtx(jntNo));
    }
}

/* 80327858-803279A0 322198 0148+00 1/0 0/0 0/0 .text            calcDiffTexMtx__8J3DModelFv */
// NONMATCHING regalloc
void J3DModel::calcDiffTexMtx() {
    j3dSys.setModel(this);

    for (u16 num = mModelData->getMaterialNum(), i = 0; i < num; i++) {
        j3dSys.setMatPacket(&mMatPacket[i]);
        J3DMaterial* materialNode = mModelData->getMaterialNodePointer(i);
        materialNode->calcDiffTexMtx(getAnmMtx(materialNode->getJoint()->getJntNo()));
    }

    for (u16 num = mModelData->getShapeNum(), i = 0; i < num; i++) {
        J3DShapePacket* shapePacket = getShapePacket(i);
        J3DTexGenBlock* texGenBlock =
            mModelData->getShapeNodePointer(i)->getMaterial()->getTexGenBlock();
        for (u16 j = 0; (int)j < 8; j++) {
            J3DTexMtx* texMtxNode = texGenBlock->getTexMtx(j);
            J3DTexMtxObj* texMtxObj = shapePacket->getTexMtxObj();
            if (texMtxNode != NULL && texMtxObj != NULL) {
                texMtxObj->setMtx(j, &texMtxNode->getMtx());
            }
        }
    }
}

/* 803279A0-80327A2C 3222E0 008C+00 0/0 2/2 0/0 .text            diff__8J3DModelFv */
void J3DModel::diff() {
    for (u16 n = getModelData()->getMaterialNum(), i = 0; i < n; i++) {
        j3dSys.setMatPacket(&mMatPacket[i]);
        getModelData()->getMaterialNodePointer(i)->diff(mDiffFlag);
    }
}

/* 80327A2C-80327AA0 32236C 0074+00 0/0 1/1 2/2 .text setDeformData__8J3DModelFP13J3DDeformDataUl
 */
s32 J3DModel::setDeformData(J3DDeformData* p_deformData, u32 param_1) {
    mDeformData = p_deformData;

    if (p_deformData == NULL) {
        return 0;
    }

    s32 ret = mVertexBuffer.copyLocalVtxArray(param_1);
    if (ret) {
        return ret;
    }
    if (param_1 & 4) {
        p_deformData->offAllFlag(1);
    }
    return 0;
}

/* 80327AA0-80327BD4 3223E0 0134+00 0/0 0/0 2/2 .text setSkinDeform__8J3DModelFP13J3DSkinDeformUl
 */
s32 J3DModel::setSkinDeform(J3DSkinDeform* p_skinDeform, u32 flags) {
    mSkinDeform = p_skinDeform;

    s32 ret = kJ3DError_Success;

    if (p_skinDeform == NULL) {
        offFlag(J3DMdlFlag_SkinPosCpu);
        offFlag(J3DMdlFlag_SkinNrmCpu);
        return 5;
    } else {
        mSkinDeform->initMtxIndexArray(mModelData);

        ret = mModelData->checkFlag(0x100);
        if (ret != kJ3DError_Success) {
            mSkinDeform->changeFastSkinDL(mModelData);
            flags &= ~2;
            flags &= ~4;
            mSkinDeform->transformVtxPosNrm(mModelData);
            mSkinDeform->initSkinInfo(mModelData);
        }

        ret = 0;
        if ((~flags & 2)) {
            ret = mVertexBuffer.allocTransformedVtxPosArray();
            if (ret != kJ3DError_Success) {
                offFlag(J3DMdlFlag_SkinPosCpu);
                return ret;
            }
            onFlag(J3DMdlFlag_SkinPosCpu);
        } else {
            offFlag(J3DMdlFlag_SkinPosCpu);
        }

        if ((~flags & 4)) {
            ret = mVertexBuffer.allocTransformedVtxNrmArray();
            if (ret != kJ3DError_Success) {
                offFlag(J3DMdlFlag_SkinNrmCpu);
                return ret;
            }
            onFlag(J3DMdlFlag_SkinNrmCpu);
        } else {
            offFlag(J3DMdlFlag_SkinNrmCpu);
        }
    }

    return ret;
}

/* 80327BD4-80327C58 322514 0084+00 1/1 0/0 2/2 .text            calcAnmMtx__8J3DModelFv */
void J3DModel::calcAnmMtx() {
    j3dSys.setModel(this);

    if (checkFlag(2)) {
        getModelData()->getJointTree().calc(mMtxBuffer, j3dDefaultScale, j3dDefaultMtx);
    } else {
        getModelData()->getJointTree().calc(mMtxBuffer, mBaseScale, mBaseTransformMtx);
    }
}

/* 80327C58-80327CA4 322598 004C+00 1/1 1/1 1/1 .text            calcWeightEnvelopeMtx__8J3DModelFv
 */
void J3DModel::calcWeightEnvelopeMtx() {
    if (getModelData()->getWEvlpMtxNum() != 0 && !checkFlag(0x10)) {
        if (!getModelData()->checkFlag(0x100)) {
            mMtxBuffer->calcWeightEnvelopeMtx();
        }
    }
}

/* 80327CA4-80327CF0 3225E4 004C+00 1/0 0/0 0/0 .text            update__8J3DModelFv */
void J3DModel::update() {
    calc();
    entry();
}


/* 80327CF0-80327E4C 322630 015C+00 1/0 0/0 0/0 .text            calc__8J3DModelFv */
void J3DModel::calc() {
    j3dSys.setModel(this);

    if (checkFlag(J3DMdlFlag_SkinPosCpu)) {
        j3dSys.onFlag(J3DSysFlag_SkinPosCpu);
    } else {
        j3dSys.offFlag(J3DSysFlag_SkinPosCpu);
    }

    if (checkFlag(J3DMdlFlag_SkinNrmCpu)) {
        j3dSys.onFlag(J3DSysFlag_SkinNrmCpu);
    } else {
        j3dSys.offFlag(J3DSysFlag_SkinNrmCpu);
    }

    getModelData()->syncJ3DSysFlags();
    mVertexBuffer.frameInit();

    if (mUnkCalc2 != NULL) {
        mUnkCalc2->calc(getModelData());
    }

    if (mDeformData != NULL) {
        mDeformData->deform(this);
    }

    if (mVtxColorCalc != NULL) {
        mVtxColorCalc->calc(this);
    }

    if (mUnkCalc1 != NULL) {
        mUnkCalc1->calc(this);
    }

    calcAnmMtx();
    calcWeightEnvelopeMtx();

    if (mSkinDeform != NULL) {
        mSkinDeform->deform(this);
    }

    if (mCalcCallBack != NULL) {
        mCalcCallBack(this, 0);
    }
}

/* 80327E4C-80327F40 32278C 00F4+00 1/0 0/0 0/0 .text            entry__8J3DModelFv */
void J3DModel::entry() {
    j3dSys.setModel(this);

    if (checkFlag(J3DMdlFlag_SkinPosCpu)) {
        j3dSys.onFlag(J3DSysFlag_SkinPosCpu);
    } else {
        j3dSys.offFlag(J3DSysFlag_SkinPosCpu);
    }

    if (checkFlag(J3DMdlFlag_SkinNrmCpu)) {
        j3dSys.onFlag(J3DSysFlag_SkinNrmCpu);
    } else {
        j3dSys.offFlag(J3DSysFlag_SkinNrmCpu);
    }

    getModelData()->syncJ3DSysFlags();
    j3dSys.setTexture(getModelData()->getTexture());

    for (u16 i = 0; i < getModelData()->getJointNum(); i++) {
        J3DJoint* joint = getModelData()->getJointNodePointer(i);
        if (joint->getMesh() != NULL) {
            joint->entryIn();
        }
    }
}

/* 80327F40-80328190 322880 0250+00 1/0 0/0 0/0 .text            viewCalc__8J3DModelFv */
void J3DModel::viewCalc() {
    mMtxBuffer->swapDrawMtx();
    mMtxBuffer->swapNrmMtx();

    if (mModelData->checkFlag(0x10)) {
        if (getMtxCalcMode() == 2) {
            J3DCalcViewBaseMtx(j3dSys.getViewMtx(), mBaseScale, mBaseTransformMtx,
                               (MtxP)&mInternalView);
        }
    } else if (isCpuSkinningOn()) {
        if (getMtxCalcMode() == 2) {
            J3DCalcViewBaseMtx(j3dSys.getViewMtx(), mBaseScale, mBaseTransformMtx,
                               (MtxP)&mInternalView);
        }
    } else if (checkFlag(J3DMdlFlag_SkinPosCpu)) {
        mMtxBuffer->calcDrawMtx(getMtxCalcMode(), mBaseScale, mBaseTransformMtx);
        calcNrmMtx();
        calcBumpMtx();
        DCStoreRangeNoSync(getDrawMtxPtr(), mModelData->getDrawMtxNum() * sizeof(Mtx));
        DCStoreRange(getNrmMtxPtr(), mModelData->getDrawMtxNum() * sizeof(Mtx33));
    } else if (checkFlag(J3DMdlFlag_SkinNrmCpu)) {
        mMtxBuffer->calcDrawMtx(getMtxCalcMode(), mBaseScale, mBaseTransformMtx);
        calcBBoardMtx();
        DCStoreRange(getDrawMtxPtr(), mModelData->getDrawMtxNum() * sizeof(Mtx));
    } else {
        mMtxBuffer->calcDrawMtx(getMtxCalcMode(), mBaseScale, mBaseTransformMtx);
        calcNrmMtx();
        calcBBoardMtx();
        calcBumpMtx();
        DCStoreRangeNoSync(getDrawMtxPtr(), mModelData->getDrawMtxNum() * sizeof(Mtx));
        DCStoreRange(getNrmMtxPtr(), mModelData->getDrawMtxNum() * sizeof(Mtx33));
    }

    prepareShapePackets();
}

/* 80328190-803281B4 322AD0 0024+00 1/1 0/0 0/0 .text            calcNrmMtx__8J3DModelFv */
void J3DModel::calcNrmMtx() {
    mMtxBuffer->calcNrmMtx();
}

/* 803281B4-803282B8 322AF4 0104+00 1/1 0/0 0/0 .text            calcBumpMtx__8J3DModelFv */
void J3DModel::calcBumpMtx() {
    if (getModelData()->checkBumpFlag() == 1) {
        u32 bumpMtxIdx = 0;
        u16 materialNum = getModelData()->getMaterialNum();
        u16 i = 0;

        for (; i < materialNum; i++) {
            J3DMaterial* material = getModelData()->getMaterialNodePointer(i);
            if (material->getNBTScale()->mbHasScale == 1) {
                material->getShape()->calcNBTScale(*material->getNBTScale()->getScale(),
                                                   getNrmMtxPtr(), getBumpMtxPtr(bumpMtxIdx));
                DCStoreRange(getBumpMtxPtr(bumpMtxIdx), getModelData()->getDrawMtxNum() * 0x24);
                bumpMtxIdx++;
            }
        }
    }
}

/* 803282B8-803282EC 322BF8 0034+00 1/1 0/0 0/0 .text            calcBBoardMtx__8J3DModelFv */
void J3DModel::calcBBoardMtx() {
    if (mModelData->checkBBoardFlag()) {
        mMtxBuffer->calcBBoardMtx();
    }
}

/* 803282EC-80328350 322C2C 0064+00 2/2 0/0 0/0 .text            prepareShapePackets__8J3DModelFv */
void J3DModel::prepareShapePackets() {
    u16 shapeNum = getModelData()->getShapeNum();

    for (u16 i = 0; i < shapeNum; i++) {
        J3DShape* xx = mModelData->getShapeNodePointer(i);
        J3DShapePacket* pkt = getShapePacket(i);
        pkt->setMtxBuffer(mMtxBuffer);
        if (getMtxCalcMode() == 2) {
            pkt->setBaseMtxPtr(&mInternalView);
        } else {
            pkt->setBaseMtxPtr(&j3dSys.mViewMtx);
        }
    }
}
