//
// Generated By: dol2asm
// Translation Unit: d/d_attention
//

#include "d/d_attention.h"
#include "JSystem/J3DGraphBase/J3DMaterial.h"
#include "JSystem/JKernel/JKRSolidHeap.h"
#include "d/actor/d_a_player.h"
#include "d/d_com_inf_game.h"
#include "dol2asm.h"
#include "f_op/f_op_actor_mng.h"
#include "m_Do/m_Do_controller_pad.h"

class dAttDrawParam_c {
public:
    /* 80070158 */ dAttDrawParam_c();
    /* 80073FC4 */ virtual ~dAttDrawParam_c();

    /* 0x4 */ s8 field_0x4;
    /* 0x8 */ f32 mCursorDistance;
    /* 0xC */ f32 field_0xc;
};

/* 80070018-80070038 06A958 0020+00 2/2 0/0 0/0 .text padLockButton__25@unnamed@d_attention_cpp@Fl
 */
namespace {
static bool padLockButton(s32 i_padNo) {
    return mDoCPd_c::getHoldLockL(i_padNo) != 0;
}
}  // namespace

/* 803A9BF8-803A9C04 006D18 000C+00 2/2 0/0 0/0 .data            loc_type_tbl__12dAttention_c */
type_tbl_entry dAttention_c::loc_type_tbl[3] = {
    {0, 1},
    {1, 2},
    {2, 4},
};

/* 803A9C04-803A9C18 006D24 0014+00 1/1 0/0 0/0 .data            act_type_tbl__12dAttention_c */
type_tbl_entry dAttention_c::act_type_tbl[5] = {
    {3, 8}, {4, 16}, {5, 32}, {6, 64}, {7, 128},
};

/* 80450F58-80450F60 000458 0008+00 0/0 2/2 0/0 .sbss            None */
extern bool on_final_boss_stg;
bool on_final_boss_stg;

/* 80070038-80070110 06A978 00D8+00 1/1 0/0 0/0 .text            __ct__11dAttParam_cFl */
dAttParam_c::dAttParam_c(s32 param_0) {
    field_0x4 = 45.0f;
    field_0x8 = 30.0f;
    field_0xc = 90.0f;
    mFlags = 1;
    mSWModeDisable = -0.9f;

    mDangerBGMDistance = 3000.0f;
    mBGMDistMargin = 1000.0f;

    mSelCursorScaleX = 6.0f;
    mSelCursorScaleY = 4.5f;

    mAttnCursorScaleX = 14.0f;
    mAttnCursorScaleY = 14.0f;

    mSelCursorOffsetY = 10.0f;
    mAttnCursorOffsetY = 0.0f;

    mAttnCursorAppearFrames = 1;
    mAttnCursorDisappearFrames = 1;

    field_0x38 = 1.7f;
    field_0x3c = 1.0f;

    on_final_boss_stg = strcmp(dComIfGp_getStartStageName(), "D_MN09B") == 0;
}


/* 80070110-80070158 06AA50 0048+00 2/1 0/0 0/0 .text            __dt__11dAttParam_cFv */
dAttParam_c::~dAttParam_c() {}

/* 80070158-80070178 06AA98 0020+00 1/1 0/0 0/0 .text            __ct__15dAttDrawParam_cFv */
dAttDrawParam_c::dAttDrawParam_c() {
    mCursorDistance = 250.0f;
    field_0xc = 2.0f;
}

/* 80070178-80070198 06AAB8 0020+00 1/0 0/0 0/0 .text
 * execute__19dAttDraw_CallBack_cFUsP16J3DTransformInfo         */
int dAttDraw_CallBack_c::execute(u16 param_0, J3DTransformInfo* param_1) {
    if (param_0 == 0) {
        param_1->mTranslate.y *= 0.6f;
    }

    return 1;
}

/* 80424B0C-80424B20 05182C 0010+04 3/3 0/0 0/0 .bss             g_AttDwHIO */
static dAttDrawParam_c g_AttDwHIO;

/* 80070198-80070774 06AAD8 05DC+00 0/0 1/1 0/0 .text __ct__12dAttention_cFP10fopAc_ac_cUl */
dAttention_c::dAttention_c(fopAc_ac_c* i_player, u32 i_padNo) {
    mpPlayer = i_player;
    mPadNo = i_padNo;

    mLockTargetID = -1;
    field_0x32e = 0;
    field_0x32f = 0;

    mCheckObjectOffset = 0;
    mActionOffset = 0;
    mLockOnOffset = 0;
    initList(-1);

    mPlayerAttentionFlags = 0;
    field_0x32a = 0;
    mAttnStatus = ST_NONE;
    field_0x32b = 4;
    field_0x32c = 0;
    mAttnBlockTimer = 0;

    heap = mDoExt_createSolidHeapFromGameToCurrent(0x9000, 0);

    J3DModelData* modelDataR = (J3DModelData*)dComIfG_getObjectRes("Always", 0x25);
    J3DModelData* modelDataY = (J3DModelData*)dComIfG_getObjectRes("Always", 0x26);

    for (int i = 0; i < 2; i++) {
        draw[i].mModel[0] = mDoExt_J3DModel__create(modelDataY, 0x80000, 0x11000285);
        draw[i].mModel[1] = mDoExt_J3DModel__create(modelDataR, 0x80000, 0x11000285);

        void* res = dComIfG_getObjectRes("Always", 0x11);
        draw[i].mNoticeCursorBck[0].init((J3DAnmTransform*)res, TRUE, 2, 1.0f, 0, -1, false);

        res = dComIfG_getObjectRes("Always", 0x2B);
        draw[i].mNoticeCursorBpk[0].init(modelDataY, (J3DAnmColor*)res, TRUE, 2, 1.0f, 0, -1);

        res = dComIfG_getObjectRes("Always", 0x37);
        draw[i].mNoticeCursorBrk[0].init(modelDataY, (J3DAnmTevRegKey*)res, TRUE, 2, 1.0f, 0, -1);

        res = dComIfG_getObjectRes("Always", 0x3F);
        draw[i].mNoticeCursorBtk[0].init(modelDataY, (J3DAnmTextureSRTKey*)res, TRUE, 2, 1.0f, 0,
                                         -1);

        res = dComIfG_getObjectRes("Always", 0x38);
        draw[i].mNoticeCursor02Brk[0].init(modelDataY, (J3DAnmTevRegKey*)res, TRUE, 2, 1.0f, 0, -1);

        res = dComIfG_getObjectRes("Always", 0x10);
        draw[i].mNoticeCursorBck[1].init((J3DAnmTransform*)res, TRUE, 2, 1.0f, 0, -1, false);

        res = dComIfG_getObjectRes("Always", 0x2A);
        draw[i].mNoticeCursorBpk[1].init(modelDataR, (J3DAnmColor*)res, TRUE, 2, 1.0f, 0, -1);

        res = dComIfG_getObjectRes("Always", 0x35);
        draw[i].mNoticeCursorBrk[1].init(modelDataR, (J3DAnmTevRegKey*)res, TRUE, 2, 1.0f, 0, -1);

        res = dComIfG_getObjectRes("Always", 0x3E);
        draw[i].mNoticeCursorBtk[1].init(modelDataR, (J3DAnmTextureSRTKey*)res, TRUE, 2, 1.0f, 0,
                                         -1);

        res = dComIfG_getObjectRes("Always", 0x36);
        draw[i].mNoticeCursor02Brk[1].init(modelDataR, (J3DAnmTevRegKey*)res, TRUE, 2, 1.0f, 0, -1);

        res = dComIfG_getObjectRes("Always", 0xC);
        draw[i].mImpactBck.init((J3DAnmTransform*)res, TRUE, 0, 1.0f, 0, -1, false);

        res = dComIfG_getObjectRes("Always", 0x29);
        draw[i].mImpactBpk.init(modelDataR, (J3DAnmColor*)res, TRUE, 0, 1.0f, 0, -1);

        res = dComIfG_getObjectRes("Always", 0x32);
        draw[i].mImpactBrk.init(modelDataR, (J3DAnmTevRegKey*)res, TRUE, 0, 1.0f, 0, -1);

        res = dComIfG_getObjectRes("Always", 0x3D);
        draw[i].mImpactBtk.init(modelDataR, (J3DAnmTextureSRTKey*)res, TRUE, 0, 1.0f, 0, -1);

        draw[i].field_0x170 = 0;
        draw[i].field_0x171 = 1;
        draw[i].field_0x172 = 0;
        draw[i].field_0x174 = 1;
        draw[i].field_0x173 = 2;
        draw[i].field_0x175 = 0;
    }

    mDoExt_restoreCurrentHeap();
    if ((int)mDoExt_adjustSolidHeap(heap) >= 0) {
        DCStoreRangeNoSync(heap->getStartAddr(), heap->getHeapSize());
    }

    field_0x328 = -1;
    mFlags = 0;

    mZHintTarget.init();
    mCatghTarget.init();
    mLookTarget.init();
    new (&mAttParam) dAttParam_c(0);

    g_AttDwHIO.field_0x4 = -1;
}


/* 80070774-80070844 06B0B4 00D0+00 0/0 2/2 0/0 .text            __dt__12dAttention_cFv */
dAttention_c::~dAttention_c() {
    if (heap != NULL) {
        mDoExt_destroySolidHeap(heap);
        heap = NULL;
    }
}

/* 80070844-80070880 06B184 003C+00 2/2 2/2 8/8 .text            GetLockonList__12dAttention_cFl */
dAttList_c* dAttention_c::GetLockonList(s32 param_0) {
    if (mLockonCount != 0) {
        return &mLockOnList[(mLockOnOffset + param_0) % mLockonCount];
    }

    return NULL;
}

/* 80070880-80070974 06B1C0 00F4+00 0/0 5/5 2/2 .text            getActionBtnB__12dAttention_cFv */
dAttList_c* dAttention_c::getActionBtnB() {
    int i;
    dAttList_c* list = GetLockonList(0);

    if (list != NULL && list->getActor() != NULL && list->mType == 1 && LockonTruth() &&
        !(list->getActor()->attention_info.flags & 0x2000000)) {
        return list;
    }

    if (mActionCount == 0) {
        return NULL;
    }

    for (i = 0; i < mActionCount; i++) {
        if (mActionList[i].mType == 3) {
            if (!(mActionList[i].getActor()->attention_info.flags & 0x2000000)) {
                return &mActionList[i];
            }
            continue;
        }
        return &mActionList[i];
    }

    return NULL;
}

/* 80070974-80070A70 06B2B4 00FC+00 0/0 1/1 0/0 .text            getActionBtnXY__12dAttention_cFv */
dAttList_c* dAttention_c::getActionBtnXY() {
    int i;
    dAttList_c* list = GetLockonList(0);

    if (list != NULL && list->getActor() != NULL && list->mType == 1 && LockonTruth()) {
        if (list->getActor()->eventInfo.chkCondition(dEvtCnd_CANTALKITEM_e)) {
            return list;
        }

        return NULL;
    }

    if (mActionCount == 0) {
        return NULL;
    }

    for (i = 0; i < mActionCount; i++) {
        if (mActionList[i].mType == 3) {
            if (mActionList[i].getActor()->eventInfo.chkCondition(dEvtCnd_CANTALKITEM_e)) {
                return &mActionList[i];
            }
        }
    }

    return NULL;
}

/* 80450660-80450664 0000E0 0004+00 2/2 0/0 0/0 .sdata           loc_type_num__12dAttention_c */
int dAttention_c::loc_type_num = 3;

/* 80070A70-80070AC0 06B3B0 0050+00 1/1 0/0 0/0 .text            chkAttMask__12dAttention_cFUlUl */
int dAttention_c::chkAttMask(u32 param_0, u32 param_1) {
    for (int i = 0; i < loc_type_num; i++) {
        if (param_0 == loc_type_tbl[i].field_0x0) {
            return param_1 & loc_type_tbl[i].field_0x2;
        }
    }

    return 1;
}

/* 80070AC0-80070B2C 06B400 006C+00 2/2 0/0 0/0 .text            check_event_condition__FUlUs */
static int check_event_condition(u32 i_listType, u16 i_condition) {
    switch (i_listType) {
    case 3:
    case 1:
        if (!(i_condition & 1)) {
            return true;
        }
        break;
    case 4:
    case 2:
        break;
    case 5:
        if (!(i_condition & 4)) {
            return true;
        }
        break;
    case 6:
        if (!(i_condition & 4)) {
            return true;
        }
        break;
    }

    return false;
}

/* 80450664-80450668 0000E4 0004+00 1/1 0/0 0/0 .sdata           act_type_num__12dAttention_c */
int dAttention_c::act_type_num = 5;

/* 80450668-8045066C 0000E8 0004+00 1/1 0/0 0/0 .sdata           chk_type_tbl__12dAttention_c */
type_tbl_entry dAttention_c::chk_type_tbl[1] = {
    {8, 256},
};

/* 8045066C-80450670 0000EC 0004+00 1/1 0/0 0/0 .sdata           chk_type_num__12dAttention_c */
int dAttention_c::chk_type_num = 1;

/* 80450670-80450674 0000F0 0004+00 2/2 0/0 0/0 .sdata           None */
static bool attn_opt_hold = true;

/* 80070B2C-80070BF4 06B46C 00C8+00 2/2 0/0 0/0 .text            check_flontofplayer__FUlss */
static int check_flontofplayer(u32 param_0, s16 param_1, s16 param_2) {
    static int ftp_table[9] = {
        4, 1, 2, 8, 16, 32, 64, 128, 256,
    };

    static s16 ang_table[3] = {
        0x4000, 0x2000, 0x0AAA,
    };

    static s16 ang_table2[6] = {
        0x0AAA, 0x2000, 0x2AAA, 0x4000, 0x4E38, 0x6000,
    };

    if (param_1 < 0) {
        param_1 = -param_1;
    }

    if (param_2 < 0) {
        param_2 = -param_2;
    }

    for (int i = 0; i < 3; i++) {
        if (param_0 & ftp_table[i]) {
            if (param_1 > ang_table[i]) {
                return true;
            }
        }
    }

    for (int i = 8; i > 2; i--) {
        if (param_0 & ftp_table[i]) {
            if (param_2 > ang_table2[i - 3]) {
                return true;
            }
        }
    }

    return false;
}

/* 80070BF4-80070C40 06B534 004C+00 2/2 0/0 0/0 .text            distace_weight__Ffsf */
static f32 distace_weight(f32 param_0, s16 param_1, f32 param_2) {
    f32 tmp = param_1 / 32768.0f;
    return param_0 * ((1.0f - param_2) + (param_2 * (tmp * tmp)));
}


/* 80070C40-80070CA0 06B580 0060+00 2/2 0/0 0/0 .text            distace_angle_adjust__Ffsf */
static f32 distace_angle_adjust(f32 param_0, s16 param_1, f32 param_2) {
    f32 tmp = param_1 / 32768.0f;
    if (tmp < 0.0f) {
        tmp = -tmp;
    }

    return param_0 * ((1.0f - param_2) + (param_2 * ((1.0f - tmp) * (1.0f - tmp))));
}

/* 80070CA0-80070E90 06B5E0 01F0+00 3/3 0/0 0/0 .text            check_distace__FP4cXyzsP4cXyzffff
 */
static BOOL check_distace(cXyz* param_0, s16 param_1, cXyz* param_2, f32 param_3, f32 param_4,
                          f32 param_5, f32 param_6) {
    cXyz tmp = *param_2 - *param_0;

    if (tmp.y <= param_6 || tmp.y >= param_5) {
        return false;
    }

    f32 adjust = param_3 + distace_angle_adjust(param_4, param_1, 1.0f);
    if (adjust < tmp.absXZ()) {
        return false;
    }

    return true;
}

/* 80070E90-800710C0 06B7D0 0230+00 2/2 0/0 0/0 .text
 * calcWeight__12dAttention_cFiP10fopAc_ac_cfssPUl              */
f32 dAttention_c::calcWeight(int param_0, fopAc_ac_c* param_1, f32 param_2, s16 param_3,
                             s16 param_4, u32* param_5) {
    int i;
    int num;
    type_tbl_entry* table;

    switch (param_0) {
    case 0x4C:
        if (chkFlag(0x4000)) {
            return 0.0f;
        }

        num = loc_type_num;
        table = loc_type_tbl;
        break;
    default:
    case 0x41:
        num = act_type_num;
        table = act_type_tbl;
        break;
    case 0x43:
        num = chk_type_num;
        table = chk_type_tbl;
        break;
    }

    f32 weight = 0.0f;
    f32 dvar14 = -1.0f;

    daPy_py_c* player = daPy_getPlayerActorClass();
    if (player != NULL) {
        if (param_1 == fopAcM_SearchByID(player->getGrabActorID())) {
            return 0.0f;
        }
    }

    for (i = 0; i < num; i++) {
        f32 dvar12;
        type_tbl_entry* entry = &table[i];

        if (mPlayerAttentionFlags & entry->field_0x2 & param_1->attention_info.flags) {
            u8 index = param_1->attention_info.distances[entry->field_0x0];
            dist_entry* d_entry = &dist_table[index];

            if (fopAcM_checkStatus(param_1, 0x20000000) ||
                check_event_condition(entry->field_0x0, param_1->eventInfo.getCondition())) {
                dvar12 = 0.0f;
            } else if (check_flontofplayer(d_entry->mAngleSelect, param_3, param_4)) {
                dvar12 = 0.0f;
            } else if (!check_distace(&mOwnerAttnPos, param_3, &param_1->attention_info.position,
                                      d_entry->mDistMax, d_entry->mDistanceAdjust, d_entry->mUpperY,
                                      d_entry->mLowerY)) {
                dvar12 = 0.0f;
            } else {
                dvar12 = distace_weight(param_2, param_3, 0.5f);
            }

            f32 dvar13 = d_entry->mWeight;
            if (dvar12 > 0.0f && dvar13 > dvar14) {
                dvar14 = dvar13;
                weight = dvar12 / dvar13;
                *param_5 = entry->field_0x0;
            }
        }
    }

    return weight;
}

/* 800710C0-80071240 06BA00 0180+00 1/1 0/0 0/0 .text
 * setList__12dAttention_cFiP10fopAc_ac_cff7cSAngleUl           */
void dAttention_c::setList(int param_0, fopAc_ac_c* param_1, f32 param_2, f32 param_3,
                           cSAngle param_4, u32 param_5) {
    int max;
    int* num;
    s32 maxIndex;
    dAttList_c* list;

    switch (param_0) {
    case 0x4C:
        if (chkFlag(0x4000)) return;
        if (mLockonCount >= 1 && param_1 == mLockOnList[0].getActor() && param_5 == mLockOnList[0].mType) {
            return;
        }
        max = 8;
        num = &mLockonCount;
        list = mLockOnList;
        break;
    default:
    case 0x41:
        max = 4;
        num = &mActionCount;
        list = mActionList;
        break;
    case 0x43:
        max = 4;
        num = &mCheckObjectCount;
        list = mCheckObjectList;
        break;
    }

    f32 weight = 0.0f;

    if (param_2 > weight) {
        if (*num < max) {
            maxIndex = *num;
            (*num)++;
        } else {
            f32 maxWeight = weight;
            s32 i = 0;
            maxIndex = 0;
            for (; i < max; i++) {
                if (list[i].mWeight > maxWeight) {
                    maxWeight = list[i].mWeight;
                    maxIndex = i;
                }
            }
        }

        if (list[maxIndex].mWeight > param_2) {
            list[maxIndex].setActor(param_1);
            list[maxIndex].mWeight = param_2;
            list[maxIndex].mDistance = param_3;
            list[maxIndex].mAngle = param_4;
            list[maxIndex].mType = param_5;
        }
    }
}

/* 80071240-8007138C 06BB80 014C+00 6/6 0/0 0/0 .text            initList__12dAttention_cFUl */
void dAttention_c::initList(u32 flags) {
    mPlayerAttentionFlags = flags;
    if (chkFlag(0x4000) == 0) {
        int lockonIndex;
        mLockonCount = lockonIndex = mLockTargetID != -1 ? 1 : 0;
        if (mLockOnOffset != 0) {
            memcpy(mLockOnList, mLockOnList + mLockOnOffset, sizeof(dAttList_c));
            mLockOnList[0].mWeight = 0.0f;
        }
        mLockOnOffset = 0;
        for (; lockonIndex < 8; lockonIndex++) {
            mLockOnList[lockonIndex].setActor(NULL);
            mLockOnList[lockonIndex].mWeight = FLT_MAX;
        }
    }
    int i;
    mActionCount = mActionOffset = i = 0;
    for (; i < 4; i++) {
        mActionList[i].setActor(NULL);
        mActionList[i].mWeight = FLT_MAX;
    }
    mCheckObjectCount = mCheckObjectOffset = i = 0;
    for (; i < 4; i++) {
        mCheckObjectList[i].setActor(NULL);
        mCheckObjectList[i].mWeight = FLT_MAX;
    }
    setFlag(0x1000);
}

/* 8007138C-800713CC 06BCCC 0040+00 1/1 0/0 0/0 .text            select_attention__FP10fopAc_ac_cPv
 */
static int select_attention(fopAc_ac_c* param_0, void* i_attention) {
    if (param_0->attention_info.flags == 0) {
        return 0;
    }

    return ((dAttention_c*)i_attention)->SelectAttention(param_0);
}

/* 800713CC-80071424 06BD0C 0058+00 4/4 0/0 0/0 .text            makeList__12dAttention_cFv */
int dAttention_c::makeList() {
    fopAcIt_Executor((fopAcIt_ExecutorFunc)select_attention, this);
    setFlag(0x2000);
    return mLockonCount + mActionCount + mCheckObjectCount;
}

/* 80071424-80071488 06BD64 0064+00 1/1 0/0 0/0 .text setOwnerAttentionPos__12dAttention_cFv */
void dAttention_c::setOwnerAttentionPos() {
    mOwnerAttnPos = mpPlayer->attention_info.position;

    if (fopAcM_GetName(mpPlayer) == PROC_ALINK) {
        mOwnerAttnPos.y -= ((daPy_py_c*)mpPlayer)->getAttentionOffsetY();
    }
}

/* 80071488-8007167C 06BDC8 01F4+00 1/1 0/0 0/0 .text
 * SelectAttention__12dAttention_cFP10fopAc_ac_c                */
int dAttention_c::SelectAttention(fopAc_ac_c* param_0) {
    cSAngle acStack_4c;
    cSAngle acStack_50;
    if (param_0 == mpPlayer || mpPlayer == NULL) {
        return 0;
    }
    mPlayerAttentionFlags = mpPlayer->attention_info.flags;
    cSGlobe acStack_40(param_0->attention_info.position - mOwnerAttnPos);
    acStack_4c = acStack_40.U() - fopAcM_GetShapeAngle_p(mpPlayer)->y;
    acStack_50 = cSAngle(acStack_40.U().Inv()) - fopAcM_GetShapeAngle_p(param_0)->y;
    u32 local_48;
    if ((param_0->attention_info.flags & 7) != 0 && chkFlag(0x4000) == 0)
    {
        f32 dVar5 = calcWeight(0x4c, param_0, acStack_40.R(), acStack_4c.Val(), acStack_50.Val(), &local_48);
        setList(0x4c, param_0, dVar5, acStack_40.R(), acStack_4c, local_48);
    }
    if ((param_0->attention_info.flags & 0xf8) != 0) {
        f32 dVar5 = calcWeight(0x41, param_0, acStack_40.R(), acStack_4c.Val(), acStack_50.Val(), &local_48);
        setList(0x41, param_0, dVar5, acStack_40.R(), acStack_4c, local_48);
    }
    if (((param_0->attention_info).flags & 0x100) != 0) {
        f32 dVar5 = calcWeight(0x43, param_0, acStack_40.R(), acStack_4c.Val(), acStack_50.Val(), &local_48);
        setList(0x43, param_0, dVar5, acStack_40.R(), acStack_4c, local_48);
    }
    return 0;
}

/* 800716B8-800718A4 06BFF8 01EC+00 4/4 0/0 0/0 .text            sortList__12dAttention_cFv */
void dAttention_c::sortList() {
    int i;
    int j;
    int count;
    dAttList_c temp;
    dAttList_c* list;

    if (!chkFlag(0x4000)) {
        list = mLockOnList;
        for (i = (mLockTargetID != -1) ? 1 : 0, count = mLockonCount; i < count - 1; i++) {
            for (j = i + 1; j < count; j++) {
                if (list[i].mWeight > list[j].mWeight) {
                    memcpy(&temp, &list[j], sizeof(dAttList_c));
                    memcpy(&list[j], &list[i], sizeof(dAttList_c));
                    memcpy(&list[i], &temp, sizeof(dAttList_c));
                }
            }
        }
    }

    list = mActionList;
    count = mActionCount;
    for (i = 0; i < count - 1; i++) {
        for (j = i + 1; j < count; j++) {
            if (list[i].mWeight > list[j].mWeight) {
                memcpy(&temp, &list[j], sizeof(dAttList_c));
                memcpy(&list[j], &list[i], sizeof(dAttList_c));
                memcpy(&list[i], &temp, sizeof(dAttList_c));
            }
        }
    }

    list = mCheckObjectList;
    count = mCheckObjectCount;
    for (i = 0; i < count - 1; i++) {
        for (j = i + 1; j < count; j++) {
            if (list[i].mWeight > list[j].mWeight) {
                memcpy(&temp, &list[j], sizeof(dAttList_c));
                memcpy(&list[j], &list[i], sizeof(dAttList_c));
                memcpy(&list[i], &temp, sizeof(dAttList_c));
            }
        }
    }
}

/* 800718A4-80071960 06C1E4 00BC+00 2/2 0/0 0/0 .text            stockAttention__12dAttention_cFv */
void dAttention_c::stockAttention() {
    fopAc_ac_c* target = LockonTarget(0);

    initList(-1);
    if (makeList()) {
        sortList();
    }

    if (target != mLockOnList[0].getActor()) {
        if (target != NULL) {
            if (mLockOnList[0].getActor() != NULL) {
                setFlag(2);
            }
        } else {
            setFlag(1);
        }
        setFlag(4);
    }

    LockonTarget(0);
}

/* 80071960-80071A68 06C2A0 0108+00 2/2 0/0 0/0 .text            nextAttention__12dAttention_cFv */
fopAc_ac_c* dAttention_c::nextAttention() {
    if (!attn_opt_hold && mLockonCount == 1) {
        field_0x32e = 0;
        return NULL;
    }

    if (field_0x32e != 0) {
        mLockOnOffset++;

        if (mLockOnOffset >= mLockonCount) {
            mLockOnOffset = 0;
        }
        return LockonTarget(0);
    }

    fopAc_ac_c* actor = fopAcM_SearchByID(mLockTargetID);
    initList(-1);

    if (makeList()) {
        sortList();
    }

    if (actor == mLockOnList[0].getActor() && mLockonCount > 1) {
        mLockOnOffset = 1;
    }

    return LockonTarget(0);
}

/* 80071A68-80071A98 06C3A8 0030+00 3/3 0/0 0/0 .text            freeAttention__12dAttention_cFv */
int dAttention_c::freeAttention() {
    mLockTargetID = -1;
    initList(-1);
    return 0;
}

/* 80071A98-80071CC0 06C3D8 0228+00 2/2 0/0 0/0 .text            chaseAttention__12dAttention_cFv */
bool dAttention_c::chaseAttention() {
    int offset = mLockOnOffset;
    fopAc_ac_c* actor = mLockOnList[offset].getActor();

    if (actor == NULL) {
        return false;
    }

    if (!chkFlag(0x4000)) {
        cSGlobe g1 = actor->attention_info.position - mOwnerAttnPos;
        cSAngle a1;
        a1 = g1.U() - fopAcM_GetShapeAngle_p(mpPlayer)->y;

        cSGlobe g2(mOwnerAttnPos - actor->attention_info.position);
        cSAngle a2;
        a2 = g2.U() - fopAcM_GetShapeAngle_p(actor)->y;

        u32 type;
        f32 weight = calcWeight(0x4C, actor, g1.R(), a1.Val(), a2.Val(), &type);
        if (weight <= 0.0f) {
            type = mLockOnList[offset].mType;
            int tbl_idx = actor->attention_info.distances[type];

            if (!chkAttMask(type, actor->attention_info.flags)) {
                return false;
            } else if (check_event_condition(type, actor->eventInfo.getCondition())) {
                return false;
            } else if (check_flontofplayer(dist_table[tbl_idx].mAngleSelect, a1.Val(), a2.Val())) {
                return false;
            } else if (check_distace(&mOwnerAttnPos, a1.Val(), &actor->attention_info.position,
                                     dist_table[tbl_idx].mDistMaxRelease,
                                     dist_table[tbl_idx].mDistanceAdjust,
                                     dist_table[tbl_idx].mUpperY, dist_table[tbl_idx].mLowerY)) {
                mLockOnList[offset].mWeight = distace_weight(g1.R(), a1.Val(), 0.5f);
                return true;
            }

            return false;
        }

        mLockOnList[offset].setActor(actor);
        mLockOnList[offset].mWeight = weight;
        mLockOnList[offset].mDistance = g1.R();
        mLockOnList[offset].mType = type;
        return true;
    }

    return (actor->attention_info.flags & 7) != false;
}


/* 80071CC0-80071D6C 06C600 00AC+00 1/1 0/0 0/0 .text EnemyDistance__12dAttention_cFP10fopAc_ac_c
 */
f32 dAttention_c::EnemyDistance(fopAc_ac_c* i_actor) {
    f32 distance;

    if (i_actor == mpPlayer || mpPlayer == NULL) {
        distance = -1.0f;
    } else if (fopAcM_GetProfName(i_actor) == PROC_ALINK) {
        distance = -1.0f;
    } else if (!(i_actor->attention_info.flags & 4) &&
               !(i_actor->attention_info.flags & 0x4000000)) {
        distance = -1.0f;
    } else {
        distance = fopAcM_searchActorDistance(mpPlayer, i_actor);
        u8 tmp = i_actor->attention_info.distances[fopAc_attn_BATTLE_e];

        if (distance < dist_table[tmp].mDistMax + dist_table[tmp].mDistanceAdjust) {
            return distance;
        }

        distance = -1.0f;
    }

    return distance;
}


/* 80071D6C-80071DEC 06C6AC 0080+00 1/1 0/0 0/0 .text            sound_attention__FP10fopAc_ac_cPv
 */
static int sound_attention(fopAc_ac_c* param_0, void* i_attention) {
    f32 dist = ((dAttention_c*)i_attention)->EnemyDistance(param_0);

    if (dist < 0.0f) {
        return 0;
    }

    if (dist < ((dAttention_c*)i_attention)->mEnemyDist) {
        ((dAttention_c*)i_attention)->mEnemyActorID = fopAcM_GetID(param_0);
        ((dAttention_c*)i_attention)->mEnemyDist = dist;
    }

    return 0;
}


/* 80071DEC-80071E84 06C72C 0098+00 1/1 0/0 0/0 .text            runSoundProc__12dAttention_cFv */
void dAttention_c::runSoundProc() {
    mEnemyActorID = -1;
    mEnemyDist = 10000.0f;

    if (!chkFlag(0x80000000)) {
        fopAcIt_Executor((fopAcIt_ExecutorFunc)sound_attention, this);

        if (fopAcM_SearchByID(mEnemyActorID) != NULL) {
            mDoAud_bgmNowBattle(mEnemyDist * 0.1f);
            setFlag(0x100);
        }
    }
}

/* 80071E84-800720F4 06C7C4 0270+00 1/1 0/0 0/0 .text            runDrawProc__12dAttention_cFv */
void dAttention_c::runDrawProc() {
    if ((mFlags >> 3) & 1) {
        draw[0].setAlphaAnm(mAttParam.mAttnCursorAppearFrames, 0);
        draw[0].setAnm(1, mAttParam.field_0x3c);
        draw[0].field_0x164.x = mAttParam.mAttnCursorScaleX;
        draw[0].field_0x164.y = mAttParam.mAttnCursorScaleY;
        draw[0].field_0x164.z = mAttParam.mAttnCursorOffsetY;
        draw[0].field_0x175 = 1;

        if (!dComIfGp_checkPlayerStatus0(0, 0x36a02311) ||
            dComIfGp_checkPlayerStatus1(0, 0x11)) {
            lockSoundStart(Z2SE_SY_L_FOCUS_SET);
        }
    } else if (chkFlag(0x10)) {
        draw[0].setAlphaAnm(mAttParam.mAttnCursorDisappearFrames, 1);
        if (field_0x328 >= 0) {
            field_0x328 = 1;
            setFlag(0x40000000);
        }

        if (!dComIfGp_checkPlayerStatus0(0, 0x36a02311) ||
            dComIfGp_checkPlayerStatus1(0, 0x11)) {
            lockSoundStart(Z2SE_SY_L_FOCUS_RESET);
        }
    } else if (chkFlag(0x1)) {
        draw[0].setAnm(0, mAttParam.field_0x38);
        draw[0].setAlphaAnm(mAttParam.mAttnCursorAppearFrames, 0);

        draw[0].field_0x164.x = mAttParam.mSelCursorScaleX;
        draw[0].field_0x164.y = mAttParam.mSelCursorScaleY;
        draw[0].field_0x164.z = mAttParam.mSelCursorOffsetY;
        draw[0].field_0x175 = 0;
        setFlag(0x40000000);
    } else if (chkFlag(0x2)) {
        draw[0].setAlphaAnm(mAttParam.mAttnCursorAppearFrames, 0);
        draw[1].setAnm(0, mAttParam.field_0x38);
        draw[1].setAlphaAnm(mAttParam.mAttnCursorDisappearFrames, 1);

        draw[1].field_0x164.x = mAttParam.mSelCursorScaleX;
        draw[1].field_0x164.y = mAttParam.mSelCursorScaleY;
        draw[1].field_0x164.z = mAttParam.mSelCursorOffsetY;
        draw[1].field_0x175 = 0;
        setFlag(0x40000000);
    } else if (mLockonCount <= 0 && field_0x328 == 0) {
        draw[0].setAlphaAnm(mAttParam.mAttnCursorDisappearFrames, 1);
        field_0x328 = 1;
        setFlag(0x40000000);
    }

    if (mAttnStatus == ST_LOCK) {
        if (draw[0].field_0x173 == 3) {
            draw[0].field_0x173 = 4;
            clrFlag(0x40000000);
        }
    } else if (draw[0].field_0x173 == 3) {
        draw[0].field_0x173 = 4;
        clrFlag(0x40000000);
        field_0x328 = -1;
    }
}

/* 800720F4-800720F8 06CA34 0004+00 1/1 0/0 0/0 .text            runDebugDisp__12dAttention_cFv */
void dAttention_c::runDebugDisp() {}

/* 800720F8-800722A0 06CA38 01A8+00 1/1 0/0 0/0 .text            checkButton__12dAttention_cFv */
void dAttention_c::checkButton() {
    if (on_final_boss_stg && dComIfGp_roomControl_getStayNo() == 0 &&
        !dComIfGs_isSaveDunSwitch(1)) {
        if (field_0x32b == 1 && LockonTarget(0) != NULL && chkFlag(0x20000000)) {
            setFlag(0x1000000);
        }
    }

    if (dComIfGp_checkPlayerStatus0(0, 0x36a02311) || dComIfGp_checkPlayerStatus1(0, 0x11)) {
        switch (field_0x32b) {
        case 0:
        case 1:
            clrFlag(0x1000000);
            field_0x32b = 4;
            break;
        }

        return;
    }

    switch (field_0x32b) {
    case 4:
        if (padLockButton(mPadNo) || chkFlag(0x1000000)) {
            field_0x32b = 0;
            setFlag(0x200);
            clrFlag(0x1000000);
        }
        return;
    case 0:
        field_0x32b = 1;
    case 1:
        if (chkFlag(0x1000000)) {
            field_0x32b = 0;
            field_0x32e = 0x3C;
            setFlag(0x200);
            clrFlag(0x1000000);
            return;
        }

        if (!padLockButton(mPadNo)) {
            field_0x32b = 4;
        }
    }
}

/* 800722A0-800722EC 06CBE0 004C+00 2/2 0/0 0/0 .text            triggerProc__12dAttention_cFv */
bool dAttention_c::triggerProc() {
    if (chaseAttention()) {
        setFlag(0x8);
        return true;
    }

    return false;
}

/* 800722EC-80072344 06CC2C 0058+00 2/2 0/0 0/0 .text            lostCheck__12dAttention_cFv */
int dAttention_c::lostCheck() {
    if (chaseAttention()) {
        return false;
    }

    setFlag(0x10);
    setFlag(0x40);
    return true;
}

/* 80072344-800725F0 06CC84 02AC+00 1/1 0/0 0/0 .text judgementStatus4Hold__12dAttention_cFv */
void dAttention_c::judgementStatus4Hold() {
    switch (mAttnStatus) {
    case ST_NONE:
        field_0x32f = 0;
        field_0x32e = 0;
        mLockTargetID = -1;
        stockAttention();

        if (field_0x32b == 0 && triggerProc()) {
            mAttnStatus = ST_LOCK;
            field_0x32e = 15;
        }
        break;
    case ST_LOCK:
        mLockTargetID = LockonTargetPId(0);
        field_0x32f = 0;

        if (lostCheck()) {
            mLockTargetID = -1;
            stockAttention();

            if (triggerProc()) {
                mAttnStatus = ST_LOCK;
            } else {
                mAttnStatus = ST_NONE;
                freeAttention();
                setFlag(0x800000);
            }
        } else if (field_0x32b == 4) {
            mAttnStatus = ST_RELEASE;
            setFlag(0x10);
            field_0x32f = 10;
        } else if (field_0x32e == 0) {
            initList(-1);

            if (makeList()) {
                sortList();
            }
        }

        if (field_0x32e != 0) {
            field_0x32e--;
        }

        break;
    case ST_RELEASE:
        setFlag(0x40);

        if (lostCheck()) {
            mLockTargetID = -1;
            stockAttention();

            if (triggerProc()) {
                mAttnStatus = ST_LOCK;
            } else {
                mAttnStatus = ST_NONE;
                freeAttention();
                setFlag(0x800000);
            }
        } else if (field_0x32b == 0) {
            if (nextAttention()) {
                setFlag(0x8);
                mAttnStatus = ST_LOCK;
                field_0x32e = 15;
            } else {
                mAttnStatus = ST_NONE;
                freeAttention();
            }
        } else if (LockonTarget(0) == NULL || field_0x32f == 0) {
            mAttnStatus = ST_NONE;
            freeAttention();
        }

        if (field_0x32f != 0) {
            field_0x32f--;
        }

        break;
    }

    if (!chkFlag(0x1000)) {
        setFlag(0x4000);
        initList(-1);

        if (makeList()) {
            sortList();
        }
    }
}

/* 800725F0-80072924 06CF30 0334+00 1/1 0/0 0/0 .text judgementStatus4Switch__12dAttention_cFv */
void dAttention_c::judgementStatus4Switch() {
    switch (mAttnStatus) {
    case ST_NONE:
        mLockTargetID = -1;
        stockAttention();
        field_0x32f = 0;
        field_0x32e = 0;

        if (field_0x32b == 0 && triggerProc()) {
            mAttnStatus = ST_LOCK;
            field_0x32e = 15;
            field_0x32f = 15;
        }
        break;
    case ST_LOCK:
        mLockTargetID = LockonTargetPId(0);

        if (field_0x32f == 0) {
            mAttnStatus = ST_NONE;
            freeAttention();
        } else if (lostCheck()) {
            mLockTargetID = -1;
            stockAttention();

            if (triggerProc()) {
                mAttnStatus = ST_LOCK;
            } else {
                mAttnStatus = ST_NONE;
                freeAttention();
                setFlag(0x800000);
            }
        } else if (field_0x32b == 0) {
            if (mDoCPd_c::getStickY(mPadNo) < -0.9f) {
                mAttnStatus = ST_NONE;
                freeAttention();
            } else if (nextAttention()) {
                setFlag(0x8);
                mAttnStatus = ST_LOCK;
                field_0x32e = 15;
            } else {
                mAttnStatus = ST_NONE;
                freeAttention();
            }
        } else if (field_0x32e == 0) {
            initList(-1);

            if (makeList()) {
                sortList();
            }
        }

        if (!chkFlag(0x8) && field_0x32e != 0) {
            field_0x32e--;
        }

        if (field_0x32b == 1) {
            if (field_0x32f != 0) {
                field_0x32f--;
            }
        } else {
            field_0x32f = 15;
        }

        break;
    case ST_RELEASE:
        setFlag(0x40);

        if (lostCheck()) {
            mLockTargetID = -1;
            stockAttention();

            if (triggerProc()) {
                mAttnStatus = ST_LOCK;
            } else {
                mAttnStatus = ST_NONE;
                freeAttention();
                setFlag(0x800000);
            }
        } else if (field_0x32b == 0) {
            mAttnStatus = ST_NONE;

            if (triggerProc()) {
                mAttnStatus = ST_LOCK;
                field_0x32e = 15;
                field_0x32f = 15;
            }
        } else if (LockonTarget(0) == NULL || field_0x32f == 0) {
            mAttnStatus = ST_NONE;
            freeAttention();
        }

        break;
    }

    if (!chkFlag(0x1000)) {
        setFlag(0x4000);
        initList(-1);

        if (makeList()) {
            sortList();
        }
    }
}

/* 80072924-80072BD4 06D264 02B0+00 0/0 1/1 0/0 .text            Run__12dAttention_cFv */
int dAttention_c::Run() {
    clrFlag(0x3FFFFF);

    bool usingHold = dComIfGs_getOptAttentionType() == 0;
    if (attn_opt_hold != usingHold) {
        setFlag(0x10000);
    }

    attn_opt_hold = usingHold;

    if (mAttnBlockTimer != 0) {
        mAttnBlockTimer--;
        return 1;
    }

    if (chkFlag(0x80)) {
        mpPlayer = (fopAc_ac_c*) dComIfGp_getPlayer(0);
        mPadNo = PAD_1;
    }

    setOwnerAttentionPos();

    if (dComIfGp_event_runCheck() || chkFlag(0x10000)) {
        mAttnStatus = ST_NONE;
        field_0x32b = 4;
        field_0x32c = 0;
        clrFlag(0x20000000);
        clrFlag(0x10000000);
        mLockTargetID = -1;
        freeAttention();
    } else {
        checkButton();

        if (attn_opt_hold) {
            judgementStatus4Hold();
        } else {
            judgementStatus4Switch();
        }

        if ((mFlags >> 0x17) & 1) {
            freeAttention();
            if (LockonTarget(0) == NULL) {
                setFlag(0x20000020);
            }
            setFlag(0x10000000);
            clrFlag(0x800000);
        } else if (chkFlag(0x10000000)) {
            if (!padLockButton(mPadNo)) {
                if (chkFlag(0x20000000)) {
                    lockSoundStart(Z2SE_SY_CAMERA_L_CANCEL);
                    clrFlag(0x20000000);
                }

                clrFlag(0x10000000);
            }
        } else {
            if (padLockButton(mPadNo)) {
                if (LockonTarget(0) == NULL) {
                    lockSoundStart(Z2SE_SY_CAMERA_L_MOVE);
                    setFlag(0x20000020);
                }

                setFlag(0x10000000);
            }
        }
    }

    field_0x32a = mAttnStatus;

    runSoundProc();
    runDrawProc();
    runDebugDisp();

    if (mAttnStatus == ST_LOCK) {
        dComIfGp_onCameraAttentionStatus(mPadNo, 1);
    } else {
        dComIfGp_offCameraAttentionStatus(mPadNo, 1);
    }

    mZHintTarget.proc();
    mCatghTarget.proc();
    mLookTarget.proc();

    return 1;
}

/* 80072BD4-80072D80 06D514 01AC+00 0/0 1/1 0/0 .text            Draw__12dAttention_cFv */
void dAttention_c::Draw() {
    if (mAttParam.CheckFlag(0x10)) {
        draw[0].field_0x173 = 3;
        draw[1].field_0x173 = 3;
        return;
    }

    Mtx tmp;
    MTXInverse(dComIfGd_getViewRotMtx(), tmp);
    fopAc_ac_c* target = LockonTarget(0);

    if (!dComIfGp_event_runCheck()) {
        if (target != NULL) {
            draw[0].draw(target->attention_info.position, tmp);

            if (mLockonCount >= 2 && draw[1].field_0x173 == 2) {
                int listIdx = mLockOnOffset;

                if (mLockOnOffset == 0) {
                    listIdx = mLockonCount - 1;
                } else {
                    listIdx--;
                }
                if (mLockOnList[listIdx].getActor() != NULL) {
                    fopAc_ac_c* actor = mLockOnList[listIdx].getActor();
                    draw[1].draw(actor->attention_info.position, tmp);
                }
            }

            mTargetActorID = fopAcM_GetID(target);
            mDrawAttnPos = target->attention_info.position;
            field_0x328 = 0;
        } else if (field_0x328 > 0) {
            fopAc_ac_c* actor = fopAcM_SearchByID(mTargetActorID);

            if (actor != NULL) {
                draw[0].draw(actor->attention_info.position, tmp);
                mDrawAttnPos = actor->attention_info.position;
            } else {
                draw[0].draw(mDrawAttnPos, tmp);
            }
        }
    }
}

/* 80072D80-80072DD8 06D6C0 0058+00 2/2 0/0 0/0 .text            lockSoundStart__12dAttention_cFUl
 */
void dAttention_c::lockSoundStart(u32 i_sfxID) {
    if (!chkFlag(0x400000)) {
        mDoAud_seStart(i_sfxID, NULL, 0, 0);
    }
}

/* 80072DD8-80072FE8 06D718 0210+00 1/1 0/0 0/0 .text            setAnm__10dAttDraw_cFUcf */
void dAttDraw_c::setAnm(u8 param_0, f32 param_1) {
    field_0x170 = param_0;
    mNoticeCursorBck[field_0x170].reset();
    mNoticeCursorBck[field_0x170].setPlaySpeed(param_1);
    mNoticeCursorBpk[field_0x170].reset();
    mNoticeCursorBpk[field_0x170].setPlaySpeed(param_1);
    mNoticeCursorBrk[field_0x170].reset();
    mNoticeCursorBrk[field_0x170].setPlaySpeed(param_1);
    mNoticeCursor02Brk[field_0x170].reset();
    mNoticeCursor02Brk[field_0x170].setPlaySpeed(param_1);
    mNoticeCursorBtk[field_0x170].reset();
    mNoticeCursorBtk[field_0x170].setPlaySpeed(param_1);

    if (field_0x170 == 1) {
        mImpactBck.reset();
        mImpactBpk.reset();
        mImpactBrk.reset();
        mImpactBtk.reset();
    }
}

/* 80072FE8-80073004 06D928 001C+00 1/1 0/0 0/0 .text            setAlphaAnm__10dAttDraw_cFUcUc */
void dAttDraw_c::setAlphaAnm(u8 param_0, u8 param_1) {
    field_0x171 = param_0;
    field_0x172 = 0;
    field_0x173 = 2;
    field_0x174 = param_1;
}

/* 80073004-800732AC 06D944 02A8+00 1/1 0/0 0/0 .text            alphaAnm__10dAttDraw_cFv */
void dAttDraw_c::alphaAnm() {
    f32 dVar9 = (f32)field_0x172 / (f32)field_0x171;
    f32 dVar8;
    if (field_0x174 == 1) {
        dVar8 = 1.0f - dVar9;
    } else {
        dVar8 = dVar9;
    }
    if (dVar9 == 1.0f) {
        if (field_0x170 == 1 && field_0x174 == 0) {
            if (mImpactBck.isStop() && mImpactBpk.isStop() && mImpactBrk.isStop() && mImpactBtk.isStop()) {
                field_0x175 = 0;
                field_0x173 = 3;
            }
        } else {
            field_0x173 = 3;
        }
    }
    if (field_0x172 < field_0x171) {
        field_0x172++;
    }
    J3DModelData* modelData = mModel[field_0x170]->getModelData();
    for (int iVar4 = 0; iVar4 < modelData->getMaterialNum(); iVar4++) {
        J3DMaterial* material = modelData->getMaterialNodePointer(iVar4);
        J3DGXColor* pJVar5 = (J3DGXColor*)material->getTevKColor(0);
        pJVar5->a = 255.0f * dVar8;
        material->setTevKColor(0, pJVar5);
    }
    if (field_0x175 == 0) {
        mNoticeCursorBck[field_0x170].play();
        mNoticeCursorBpk[field_0x170].play();
        mNoticeCursorBrk[field_0x170].play();
        mNoticeCursorBtk[field_0x170].play();
        mNoticeCursor02Brk[field_0x170].play();
    } else {
        mImpactBck.play();
        mImpactBpk.play();
        mImpactBrk.play();
        mImpactBtk.play();
    }
}

/* 800732B0-8007353C 06DBF0 028C+00 1/1 0/0 0/0 .text            draw__10dAttDraw_cFR4cXyzPA4_f */
void dAttDraw_c::draw(cXyz& param_0, Mtx param_1) {
    J3DModelData* modelData = mModel[field_0x170]->getModelData();

    mDoMtx_stack_c::transS(param_0.x, param_0.y + field_0x164.z, param_0.z);
    mDoMtx_stack_c::concat(param_1);
    mModel[field_0x170]->setBaseTRMtx(mDoMtx_stack_c::get());

    view_class* view = dComIfGd_getView();
    f32 temp_f31 = tan(0.01745329238474369f * (0.5f * view->fovy));
    f32 temp_f30 = (-100.0f - g_AttDwHIO.mCursorDistance) / temp_f31;

    cXyz tmp;
    MTXMultVec(dComIfGd_getViewMtx(), &param_0, &tmp);

    f32 var_f2 = 1.0f;
    if (tmp.z < temp_f30) {
        var_f2 = (tmp.z * temp_f31) / (-100.0f - g_AttDwHIO.mCursorDistance);
    }

    mModel[field_0x170]->setBaseScale(
        cXyz(field_0x164.x * var_f2, field_0x164.y * var_f2, field_0x164.x * var_f2));

    alphaAnm();

    if (field_0x175 != 0) {
        mImpactBck.entry(modelData);
        mImpactBpk.entry(modelData);
        mImpactBrk.entry(modelData);
        mImpactBtk.entry(modelData);
    } else {
        mNoticeCursorBck[field_0x170].entry(modelData);
        mNoticeCursorBpk[field_0x170].entry(modelData);
        mNoticeCursorBrk[field_0x170].entry(modelData);
        mNoticeCursorBtk[field_0x170].entry(modelData);
        mNoticeCursor02Brk[field_0x170].entry(modelData);
    }

    dComIfGd_setList3Dlast();
    mDoExt_modelUpdateDL(mModel[field_0x170]);
    dComIfGd_setList();
}

/* 8007353C-800735DC 06DE7C 00A0+00 8/8 13/13 21/21 .text            LockonTarget__12dAttention_cFl
 */
fopAc_ac_c* dAttention_c::LockonTarget(s32 param_0) {
    if (dComIfGp_checkPlayerStatus0(0, 0x36A02311) || dComIfGp_checkPlayerStatus1(0, 0x11)) {
        return NULL;
    }

    if (param_0 >= mLockonCount) {
        return NULL;
    }

    int listIdx = mLockOnOffset + param_0;
    if (listIdx >= mLockonCount) {
        listIdx -= mLockonCount;
    }

    fopAc_ac_c* actor = mLockOnList[listIdx].getActor();
    if (actor == NULL || !(actor->attention_info.flags & 7)) {
        return NULL;
    }

    return actor;
}

/* 800735DC-800736CC 06DF1C 00F0+00 0/0 1/1 0/0 .text LockonReleaseDistanse__12dAttention_cFv */
f32 dAttention_c::LockonReleaseDistanse() {
    if (!LockonTruth()) {
        return 0.0f;
    }

    fopAc_ac_c* actor = mLockOnList[mLockOnOffset].getActor();
    if (actor == NULL) {
        return 0.0f;
    }

    int idx =  actor->attention_info.distances[mLockOnList[mLockOnOffset].mType];
    cSGlobe tmp_g(actor->attention_info.position - mOwnerAttnPos);
    cSAngle tmp_a(tmp_g.U() - fopAcM_GetShapeAngle_p(mpPlayer)->y);

    return distace_angle_adjust(dist_table[idx].mDistanceAdjust, tmp_a, 1.0f) + dist_table[idx].mDistMaxRelease;
}

/* 800736CC-80073734 06E00C 0068+00 2/2 0/0 0/0 .text            LockonTargetPId__12dAttention_cFl
 */
fpc_ProcID dAttention_c::LockonTargetPId(s32 param_0) {
    if (dComIfGp_checkPlayerStatus0(0, 0x36A02311) || dComIfGp_checkPlayerStatus1(0, 0x11)) {
        return fpcM_ERROR_PROCESS_ID_e;
    }

    if (param_0 >= mLockonCount) {
        return fpcM_ERROR_PROCESS_ID_e;
    }

    int listIdx = mLockOnOffset + param_0;
    if (listIdx >= mLockonCount) {
        listIdx -= mLockonCount;
    }

    return mLockOnList[listIdx].getPid();
}

/* 80073734-8007378C 06E074 0058+00 0/0 3/3 2/2 .text            ActionTarget__12dAttention_cFl */
fopAc_ac_c* dAttention_c::ActionTarget(s32 param_0) {
    if (param_0 >= mActionCount) {
        return NULL;
    }

    int listIdx = mActionOffset + param_0;
    if (listIdx >= mActionCount) {
        listIdx -= mActionCount;
    }

    return mActionList[listIdx].getActor();
}

/* 8007378C-800737E4 06E0CC 0058+00 0/0 3/3 0/0 .text            CheckObjectTarget__12dAttention_cFl
 */
fopAc_ac_c* dAttention_c::CheckObjectTarget(s32 param_0) {
    if (param_0 >= mCheckObjectCount) {
        return NULL;
    }

    int listIdx = mCheckObjectOffset + param_0;
    if (listIdx >= mCheckObjectCount) {
        listIdx -= mCheckObjectCount;
    }

    return mCheckObjectList[listIdx].getActor();
}

/* 800737E4-80073838 06E124 0054+00 3/3 53/53 37/37 .text            LockonTruth__12dAttention_cFv
 */
bool dAttention_c::LockonTruth() {
    return (mAttnStatus == ST_LOCK || mAttnStatus == ST_RELEASE) && LockonTarget(0);
}

/* 80073838-80073864 06E178 002C+00 0/0 1/1 0/0 .text
 * checkDistance__12dAttention_cFP4cXyzsP4cXyzffff              */
int dAttention_c::checkDistance(cXyz* param_0, s16 param_1, cXyz* param_2, f32 param_3, f32 param_4,
                                f32 param_5, f32 param_6) {
    return check_distace(param_0, param_1, param_2, param_3, param_4, param_5, param_6);
}

/* 80073864-80073898 06E1A4 0034+00 11/11 3/3 8/8 .text            getActor__10dAttList_cFv */
fopAc_ac_c* dAttList_c::getActor() {
    return fopAcM_SearchByID(mActorID);
}

/* 80073898-800738B4 06E1D8 001C+00 3/3 0/0 0/0 .text setActor__10dAttList_cFP10fopAc_ac_c */
void dAttList_c::setActor(fopAc_ac_c* i_actor) {
    mActorID = fopAcM_GetID(i_actor);
}

/* 800738B4-800738CC 06E1F4 0018+00 1/1 0/0 0/0 .text            getPId__10dAttHint_cFPv */
fpc_ProcID dAttHint_c::getPId(void* i_actor) {
    return fopAcM_GetID(i_actor);
}

/* 800738CC-800738FC 06E20C 0030+00 0/0 1/1 0/0 .text            convPId__10dAttHint_cFUi */
fopAc_ac_c* dAttHint_c::convPId(fpc_ProcID i_id) {
    return fopAcM_SearchByID(i_id);
}

/* 800738FC-80073958 06E23C 005C+00 0/0 0/0 6/6 .text request__10dAttHint_cFP10fopAc_ac_ci */
int dAttHint_c::request(fopAc_ac_c* i_actor, int i_priority) {
    if (i_priority < 0) {
        i_priority = 0x1FF;
    }

    if (i_priority <= mPriority) {
        mHintActorID = getPId(i_actor);
        mPriority = i_priority;
    }

    return 1;
}

/* 80073958-80073970 06E298 0018+00 1/1 0/0 0/0 .text            init__10dAttHint_cFv */
void dAttHint_c::init() {
    mHintActorID = -1;
    field_0x8 = -1;
    mPriority = 0x200;
}

/* 80073970-8007398C 06E2B0 001C+00 1/1 0/0 0/0 .text            proc__10dAttHint_cFv */
void dAttHint_c::proc() {
    field_0x8 = mHintActorID;
    mHintActorID = -1;
    mPriority = 0x200;
}

/* 8007398C-800739BC 06E2CC 0030+00 0/0 4/4 0/0 .text            convPId__11dAttCatch_cFUi */
fopAc_ac_c* dAttCatch_c::convPId(fpc_ProcID i_id) {
    return fopAcM_SearchByID(i_id);
}

/* 800739BC-800739DC 06E2FC 0020+00 1/1 0/0 0/0 .text            init__11dAttCatch_cFv */
void dAttCatch_c::init() {
    field_0xc = 0x67;
    field_0x0 = -1;
    mCatghTargetID = -1;
    field_0x4 = 3;
}

/* 800739DC-80073A08 06E31C 002C+00 1/1 0/0 0/0 .text            proc__11dAttCatch_cFv */
void dAttCatch_c::proc() {
    mCatghTargetID = field_0x0;
    mChangeItem = field_0xc;
    field_0x0 = -1;
    field_0x4 = 3;
    field_0xc = 0x67;
}

/* 80073A08-80073CA4 06E348 029C+00 0/0 0/0 10/10 .text
 * request__11dAttCatch_cFP10fopAc_ac_cUcfffsi                  */
// NONMATCHING regalloc
// This is a weird one. Some solution was found that changes dComIfGp_getPlayer but it is incompatible
// with other calls.
// https://decomp.me/scratch/aMCEI
int dAttCatch_c::request(fopAc_ac_c* param_1, u8 param_2, f32 param_3, f32 param_4,
                              f32 param_5, s16 param_6, int param_7) {
    fopAc_ac_c* player = dComIfGp_getPlayer(0);
    if (param_7 > field_0x4) {
        return 0;
    } 
    cXyz acStack_48 = param_1->attention_info.position - player->attention_info.position;
    if (acStack_48.y < param_5 || acStack_48.y > param_4) {
        return 0;
    }
    f32 dVar7 = acStack_48.absXZ();
    if (dVar7 > param_3) {
        return 0;
    }
    if (param_6 != 0) {
        cSGlobe acStack_50(acStack_48);
        s16 sVar5 = acStack_50.U() - fopAcM_GetShapeAngle_p(player)->y;
        if (sVar5 < 0) {
            sVar5 = -sVar5;
        }
        if (sVar5 == -0x8000) {
            sVar5 = 0x7fff;
        }
        if (sVar5 > param_6) {
            return 0;
        }
    }
    if (param_7 < field_0x4 || dVar7 < field_0x8) {
        field_0x4 = param_7;
        field_0xc = param_2;
        field_0x0 = fopAcM_GetID(param_1);
        field_0x8 = dVar7;
        return 1;
    }
    return 0;
}

/* 80073CA4-80073CD4 06E5E4 0030+00 0/0 1/1 0/0 .text            convPId__10dAttLook_cFUi */
fopAc_ac_c* dAttLook_c::convPId(fpc_ProcID i_id) {
    return fopAcM_SearchByID(i_id);
}

/* 80073CD4-80073CEC 06E614 0018+00 1/1 0/0 0/0 .text            init__10dAttLook_cFv */
void dAttLook_c::init() {
    field_0x0 = -1;
    mLookTargetID = -1;
    field_0x4 = 3;
}

/* 80073CEC-80073D08 06E62C 001C+00 1/1 0/0 0/0 .text            proc__10dAttLook_cFv */
void dAttLook_c::proc() {
    mLookTargetID = field_0x0;
    field_0x0 = -1;
    field_0x4 = 3;
}

/* 80073D08-80073FC4 06E648 02BC+00 0/0 0/0 7/7 .text request__10dAttLook_cFP10fopAc_ac_cfffsi */
int dAttLook_c::request(fopAc_ac_c* param_1, f32 param_2, f32 param_3, f32 param_4,
                             s16 param_5, int param_6) {
    fopAc_ac_c* player = (fopAc_ac_c*)dComIfGp_getPlayer(0);
    if (param_6 > field_0x4) {
        return 0;
    } 
    cXyz acStack_48 = param_1->eyePos - player->eyePos;
    if (acStack_48.y < param_4 || acStack_48.y > param_3) {
        return 0;
    }
    f32 dVar7 = acStack_48.absXZ();
    if (dVar7 > param_2) {
        return 0;
    }
    if (param_5 != 0) {
        acStack_48 = param_1->current.pos - player->current.pos;
        cSGlobe acStack_50(acStack_48);
        s16 sVar5 = acStack_50.U() - fopAcM_GetShapeAngle_p(player)->y;
        if (sVar5 < 0) {
            sVar5 = -sVar5;
        }
        if (sVar5 == -0x8000) {
            sVar5 = 0x7fff;
        }
        if (sVar5 > param_5) {
            return 0;
        }
    }
    if (param_6 < field_0x4 || dVar7 < field_0x8) {
        field_0x4 = param_6;
        field_0x0 = fopAcM_GetID(param_1);
        field_0x8 = dVar7;
        return 1;
    }
    return 0;
}

/* 80073FC4-8007400C 06E904 0048+00 2/1 0/0 0/0 .text            __dt__15dAttDrawParam_cFv */
dAttDrawParam_c::~dAttDrawParam_c() {}
