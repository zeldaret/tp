name: OK Check / Progress Push

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Project Setup
      run: |
        # Install deps & setup
        python3 -m pip install --user -r tools/requirements.txt
        ./tp setup --skip-iso

        # Download WiBo
        wget https://github.com/decompals/wibo/releases/download/0.4.2/wibo
        chmod +x wibo
    - name: Run Make (OK)
      run: make all rels -j$(nproc) WINE=./wibo
    - name: Create JSON for Progress & Upload
      if: github.event_name != 'pull_request'
      env: 
        PROGRESS_API_KEY: ${{ secrets.FROGRESS_API_KEY }}
      run: |
        ./tp progress -f JSON > progress-${{ github.run_id }}.json
        ./tp upload-progress progress-${{ github.run_id }}.json -b https://progress.deco.mp/ -p twilightprincess -v gcn_usa