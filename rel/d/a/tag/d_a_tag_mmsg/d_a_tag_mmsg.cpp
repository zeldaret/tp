//
// Generated By: dol2asm
// Translation Unit: d_a_tag_mmsg
//

#include "rel/d/a/tag/d_a_tag_mmsg/d_a_tag_mmsg.h"
#include "d/com/d_com_inf_game.h"
#include "d/d_procname.h"
#include "dol2asm.h"
#include "dolphin/types.h"

//
// External References:
//

extern "C" extern leafdraw_method_class g_fopAc_Method;

/* ############################################################################################## */
/* 80D5B918-80D5BA94 000078 017C+00 1/1 0/0 0/0 .text            create__11daTagMmsg_cFv */
int daTagMmsg_c::create() {
    if (!fopAcM_CheckCondition(this, 8)) {
        new (this) daTagMmsg_c();
        fopAcM_OnCondition(this, 8);
    }

    this->field_0x570 = fpcM_GetParam(this) & 0x3FF;
    this->field_0x572 = (fpcM_GetParam(this) >> 10) & 0x3FF;
    this->field_0x56b = (fpcM_GetParam(this) >> 29) & 1;
    this->field_0x568 = this->shape_angle.x;
    this->field_0x569 = (this->shape_angle.x >> 8) & 0xFF;

    if ((fpcM_GetParam(this) >> 30) & 1) {
        this->mScale.x *= 10.0f;
        this->mScale.y *= 10.0f;
    }

    this->field_0x574 = this->mScale.x * (10000.0f * this->mScale.x);
    this->field_0x578 = this->current.pos.y + this->mScale.y * 100.0f;
    this->mAttention = this->shape_angle.y;

    if (!checkNoAttention()) {
        s32 roomNo = fopAcM_GetRoomNo(this);
        cXyz* tmp =
            &dComIfGp_getRoomArrow(roomNo)
                 ->mEntries[dComIfGp_getRoomCamera(roomNo)->field_0x4[this->mAttention].field_0x10]
                 .mPosition;
        this->mEyePos.set(tmp->x, tmp->y, tmp->z);
        this->mAttentionInfo.mPosition = this->mEyePos;
    }

    this->shape_angle.y = fopAcM_searchPlayerAngleY(this);
    return 4;
}

/* 80D5BA94-80D5BAB4 0001F4 0020+00 1/0 0/0 0/0 .text            daTagMmsg_Create__FP10fopAc_ac_c */
static int daTagMmsg_Create(fopAc_ac_c* tag) {
    return static_cast<daTagMmsg_c*>(tag)->create();
}

/* 80D5BAB4-80D5BB08 000214 0054+00 1/1 0/0 0/0 .text            __dt__11daTagMmsg_cFv */
daTagMmsg_c::~daTagMmsg_c() {}

/* 80D5BB08-80D5BB30 000268 0028+00 1/0 0/0 0/0 .text            daTagMmsg_Delete__FP11daTagMmsg_c
 */
static int daTagMmsg_Delete(daTagMmsg_c* tag) {
    tag->~daTagMmsg_c();
    return 1;
}

/* 80D5BB30-80D5BD08 000290 01D8+00 1/1 0/0 0/0 .text            execute__11daTagMmsg_cFv */
int daTagMmsg_c::execute() {
    if (daPy_py_c::getMidnaActor() == NULL) {
        return 1;
    }

    if (this->field_0x572 != 0x3FF &&
        i_dComIfGs_isEventBit(dSv_event_flag_c::saveBitLabels[this->field_0x572])) {
        return 1;
    }

    if (this->field_0x569 != 0xFF &&
        dComIfGs_isSwitch(this->field_0x569, fopAcM_GetHomeRoomNo(this))) {
        fopAcM_delete(this);
        return 1;
    }

    if (this->mUseFlg && !i_dComIfGp_event_runCheck() && this->field_0x56b &&
        this->field_0x569 != 0xFF) {
        dComIfGs_onSwitch(this->field_0x569, fopAcM_GetHomeRoomNo(this));
        fopAcM_delete(this);
        return 1;
    }

    daPy_py_c* player = daPy_getLinkPlayerActorClass();
    if ((this->current.pos.y <= player->current.pos.y) &&
        (this->field_0x578 >= player->current.pos.y) &&
        (fopAcM_searchPlayerDistanceXZ2(this) < this->field_0x574) &&
        (this->field_0x570 == 0x3FF ||
         i_dComIfGs_isEventBit(dSv_event_flag_c::saveBitLabels[this->field_0x570])) &&
        (this->field_0x568 == 0xFF ||
         dComIfGs_isSwitch(this->field_0x568, fopAcM_GetHomeRoomNo(this)))) {
        player->setMidnaMsgNum(this, this->shape_angle.z);
    }

    return 1;
}

/* 80D5BD08-80D5BD28 000468 0020+00 1/0 0/0 0/0 .text            daTagMmsg_Execute__FP11daTagMmsg_c
 */
static int daTagMmsg_Execute(daTagMmsg_c* tag) {
    return tag->execute();
}

/* 80D5BD28-80D5BD30 000488 0008+00 1/0 0/0 0/0 .text            daTagMmsg_Draw__FP11daTagMmsg_c */
static bool daTagMmsg_Draw(daTagMmsg_c* tag) {
    return true;
}

/* ############################################################################################## */
/* 80D5BD44-80D5BD64 -00001 0020+00 1/0 0/0 0/0 .data            l_daTagMmsg_Method */
// This is probably of type leafdraw_method_class, but I can't get the data to have the right
// padding without these extra NULLs.
static void* l_daTagMmsg_Method[8] = {
    daTagMmsg_Create, daTagMmsg_Delete, daTagMmsg_Execute, NULL, daTagMmsg_Draw, NULL, NULL, NULL,
};

/* 80D5BD64-80D5BD94 -00001 0030+00 0/0 0/0 1/0 .data            g_profile_Tag_Mmsg */
extern actor_process_profile_definition g_profile_Tag_Mmsg = {
    -3,                                           // mLayerID
    7,                                            // mListID
    0xFFFD,                                       // mListPrio
    PROC_Tag_Mmsg,                                // mProcName
    0,                                            // unkA
    &g_fpcLf_Method.mBase,                        // mSubMtd
    sizeof(daTagMmsg_c),                          // mSize
    0,                                            // mSizeOther
    0,                                            // mParameters
    &g_fopAc_Method,                              // mSubMtd
    0x00FF,                                       // mPriority
    0,                                            // unk22[0]
    0,                                            // unk22[1]
    (leafdraw_method_class*)&l_daTagMmsg_Method,  // mSubMtd
    0x00044000,                                   // mStatus
    0x03,                                         // mActorType
    0x0E,                                         // mCullType
    0,                                            // field_0x2e[0]
    0                                             // field_0x2e[1]
};